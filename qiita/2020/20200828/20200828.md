# GitHub Actionsを利用してpytestする

# はじめに

本記事では、GitHub Actionsを利用して、Pythonのテストとカバレッジを計測するGitHub Actionsを実行したいと思います。

[GitHub Actions](https://github.co.jp/features/actions)とは、GitHubが提供するCI/CDのサービスです。

私も今まで、CircleCIを利用していましたが、とあるタイミングでGitHub Actionsが利用できるようになっており、試しに使って見たら便利だったので乗り換えようかと思っています。

CircleCIからGitHub Actionsへ乗り換えようと思ったのは以下の3点が理由です。（あまり、CircleCIもがっつり使っているわけでは無いので、間違った内容を言っていたらすいません。）

1. CircleCIでCIを実行するためには、CircleCI上で初期設定を行わなければならず、GitHubとは異なるサイトで設定を行うのが煩雑
1. GitHubにpackageやreleaseを登録しようとしたときにGitHub上でCIを走らせた方が一元管理できて良い
1. CircleCIと比べて、GitHub ActionsはCIのjobと設定ファイルが1対1で対応させることができ、jobの管理が容易である。

# GitHub Actions

## やりたいこと

* 複数のPythonのversionにてtestを走らせて特定のversionのカバレッジのみcodecovにcommitする

## 設定ファイルの置き場所

リポジトリの直下に`.github/workflows/`というフォルダを作成して、その中にjobとなるymlファイルを置いていきます。

![img]()

このときに、複数個のファイルを置くとそれぞれがjobとなります。


![ima]()


## 設定ファイルの内容

以下のCIは、以下の場合のみに実行されるように制限されています。

* masterにpushされた時
* developへpull_requestがあった時

また、テストカバレッジは、`python3.8`でのテスト結果のみcodecovへ載せるようにしています。

※設定の内容のほとんどは、参考サイトさんのを利用しています。



```
# ここに設定した名前がActions上に表示される
name: pytest

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - develop

jobs:
  pytest:
    name: Run tests with pytest
    # 実行環境として `ubuntu-latest` という名前のものを選ぶ
    runs-on: ubuntu-latest
    # 複数の Python のバージョンでテストするために `strategy.matrix` を設定する
    strategy:
      matrix:
        python-version: [3.7, 3.8]
    steps:
      # リポジトリをチェックアウトする
      # See: https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v2
      # Python のランタイムをセットアップする
      # バージョンは `strategy.matrix` に並べたものを指定する
      # See: https://github.com/actions/setup-python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}
      # Poetry そのものをインストールする
      - name: Install Poetry
        run: |
          curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python
      # Poetry へのパスを通す
      - name: Add path for Poetry
        run: echo "::add-path::$HOME/.poetry/bin"
      # インストールした Poetry を使って必要な Python パッケージをインストールする
      - name: Install Dependencies
        run: poetry install --no-interaction
      # pytest を実行する
      - name: Run Tests
        run: poetry run pytest test --cov=./slack_api_decorator --cov-report=xml
      - name: Upload coverage to Codecov
        # 上記のstepsが全て完了した場合にcodecovへupload
        if: ${{ matrix.python-version==3.8 }}
        uses: codecov/codecov-action@v1
        with:
          file: ./coverage.xml
          name: codecov-umbrella
          fail_ci_if_error: true


```

# おわりに

一旦、よく利用するpytestのGitHub Actionsを利用して見ました。
今度は、AWSへCDKを利用して自動デプロイするようになどして見たいです。

# 参考

以下のサイトさんを参考に本設定ファイルを作成しました。

* [Python Tips: PythonのプロジェクトでGitHub Actionsを使いたい](https://www.lifewithpython.com/2020/04/python-github-actions.html)
* [GitHub Actionsでブランチ毎にワークフローを分ける](https://code-log.hatenablog.com/entry/2020/02/07/201830)
* [Codecov GitHub Action](https://github.com/codecov/codecov-action)